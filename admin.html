<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.27.0";

const supabase = createClient("https://pwawgeyxzjntystktciz.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3YXdnZXl4empudHlzdGt0Y2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMjU2NTQsImV4cCI6MjA3NDkwMTY1NH0.nS4TpZT7hq1PW4lLUiDccUmJSobnXWm1GFTWskYy8jI");

let currentUser;

async function signIn() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) return alert(error.message);

  currentUser = data.user;
  document.getElementById("editor").style.display = "block";
  loadAllTexts();
}

async function loadAllTexts() {
  const container = document.getElementById("texts");
  container.innerHTML = "";

  const elements = document.querySelectorAll("h1, h2, p, div, span");
  for(const el of elements) {
    const key = el.dataset.key || el.tagName.toLowerCase() + "_" + Math.floor(Math.random()*10000);
    el.dataset.key = key;

    const { data } = await supabase.from("content").select("*").eq("key", key);
    const value = data?.[0]?.draft_text || el.innerText;

    const div = document.createElement("div");
    div.innerHTML = `<strong>${key}</strong>: <input data-key="${key}" value="${value}">`;
    container.appendChild(div);
  }
}

async function publishAll() {
  const inputs = document.querySelectorAll("#texts input");
  for(const input of inputs) {
    const key = input.dataset.key;
    const value = input.value;

    await supabase.from("content").upsert({ key, draft_text: value });

    await fetch("https://pwawgeyxzjntystktciz.supabase.co/functions/v1/Server", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ key })
    });
  }

  alert("Все изменения опубликованы!");
}

window.signIn = signIn;
window.publishAll = publishAll;
</script>
