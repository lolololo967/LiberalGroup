<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π —Å–∞–π—Ç —Å –∞–¥–º–∏–Ω–∫–æ–π</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        .admin-login-btn { 
            position: fixed; top: 20px; right: 20px; 
            background: #007bff; color: white; border: none; 
            padding: 10px 20px; border-radius: 5px; cursor: pointer; 
            z-index: 1000;
        }
        
        .admin-panel { 
            position: fixed; top: 70px; right: 20px; background: white; 
            border: 2px solid #007bff; padding: 15px; border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        
        [contenteditable="true"] { 
            border: 1px dashed #007bff; padding: 5px; margin: 2px; 
            background: #f8f9fa; 
        }
        
        [contenteditable="true"]:focus { 
            outline: none; border: 1px solid #007bff; background: #e3f2fd; 
        }
        
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
            align-items: center; z-index: 2000; 
        }
        
        .modal-content { 
            background: white; padding: 30px; border-radius: 8px; 
            min-width: 300px; 
        }
        
        .section { 
            margin: 20px 0; padding: 20px; border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        
        .publish-btn { 
            background: #28a745; color: white; border: none; 
            padding: 8px 15px; border-radius: 4px; cursor: pointer; 
            margin-right: 10px; 
        }
        
        .logout-btn { 
            background: #dc3545; color: white; border: none; 
            padding: 8px 15px; border-radius: 4px; cursor: pointer; 
        }
        
        .input-field {
            width: 100%; padding: 10px; margin: 10px 0; 
            border: 1px solid #ddd; border-radius: 4px; 
        }
        
        .login-btn {
            width: 100%; padding: 10px; background: #007bff; 
            color: white; border: none; border-radius: 4px; cursor: pointer;
        }
        
        .cancel-btn {
            width: 100%; padding: 10px; background: #6c757d; 
            color: white; border: none; border-radius: 4px; cursor: pointer;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ -->
    <button id="adminLoginBtn" class="admin-login-btn">üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤</button>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <header>
        <h1 data-content-key="site_title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –Ω–∞—à —Å–∞–π—Ç</h1>
    </header>

    <main>
        <section class="section">
            <h2 data-content-key="welcome_title">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</h2>
            <p data-content-key="welcome_text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –Ω–∞—à —Å–∞–π—Ç! –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ –º–Ω–æ–≥–æ –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.</p>
        </section>

        <section class="section">
            <h2 data-content-key="about_title">–û –Ω–∞—Å</h2>
            <p data-content-key="about_text">–ú—ã - –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤, –∑–∞–Ω–∏–º–∞—é—â–∞—è—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–µ–±-—Å–∞–π—Ç–æ–≤.</p>
        </section>

        <section class="section">
            <h2 data-content-key="contact_title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
            <p data-content-key="contact_text">Email: info@example.com | –¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-45-67</p>
        </section>
    </main>

    <footer>
        <p data-content-key="footer_text">¬© 2024 –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
    </footer>

    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
    <div id="adminPanel" class="admin-panel hidden">
        <h3>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
        <button id="publishBtn" class="publish-btn">üì¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <button id="logoutBtn" class="logout-btn">üö™ –í—ã–π—Ç–∏</button>
        <div id="statusMessage" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
    <div id="loginModal" class="modal hidden">
        <div class="modal-content">
            <h3>üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
            <input type="password" id="adminPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="input-field">
            <button id="loginBtn" class="login-btn">–í–æ–π—Ç–∏</button>
            <button id="cancelBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
            <div id="loginMessage" style="margin-top: 10px; text-align: center; color: #dc3545;"></div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase - —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
        const getSupabaseConfig = () => {
            // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ Vercel –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ Environment Variables
            if (window.location.hostname.includes('vercel.app')) {
                return {
                    url: 'https://your-project.supabase.co', // Vercel –∑–∞–º–µ–Ω–∏—Ç —ç—Ç–æ
                    key: 'your-anon-key' // Vercel –∑–∞–º–µ–Ω–∏—Ç —ç—Ç–æ
                };
            } else {
                // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)
                return {
                    url: 'https://your-project.supabase.co', // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL
                    key: 'your-anon-key' // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –ö–õ–Æ–ß
                };
            }
        };

        const config = getSupabaseConfig();
        const supabase = window.supabase.createClient(config.url, config.key);
        
        let isAdmin = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å —Å–∞–π—Ç–∞
        async function loadContent() {
            try {
                showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...');
                const { data, error } = await supabase
                    .from('site_content')
                    .select('*');

                if (error) throw error;

                if (data) {
                    data.forEach(item => {
                        const elements = document.querySelectorAll(`[data-content-key="${item.content_key}"]`);
                        elements.forEach(el => {
                            if (el.textContent !== item.content_value) {
                                el.textContent = item.content_value;
                            }
                        });
                    });
                    showStatus('–ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞', 'error');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        async function saveContent(key, value) {
            const { error } = await supabase
                .from('site_content')
                .upsert({ 
                    content_key: key, 
                    content_value: value,
                    updated_at: new Date().toISOString()
                }, {
                    onConflict: 'content_key'
                });

            if (error) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`);
            }
        }

        // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
        async function publishChanges() {
            try {
                showStatus('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π...');
                
                const elements = document.querySelectorAll('[data-content-key]');
                let changesCount = 0;

                for (const element of elements) {
                    const key = element.getAttribute('data-content-key');
                    const value = element.textContent;
                    
                    await saveContent(key, value);
                    changesCount++;
                }

                showStatus(`–£—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ ${changesCount} –∏–∑–º–µ–Ω–µ–Ω–∏–π!`, 'success');
                
                // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                setTimeout(() => {
                    if (isAdmin) showStatus('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω');
                }, 3000);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
                showStatus('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + error.message, 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        async function checkPassword(password) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                const { data, error } = await supabase
                    .from('admins')
                    .select('*')
                    .eq('username', 'admin')
                    .single();

                if (error || !data) {
                    return false;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
                return await verifyPassword(password, data.password_hash);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è:', error);
                return false;
            }
        }

        // –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        async function verifyPassword(password, storedHash) {
            try {
                // –•–µ—à–∏—Ä—É–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ö—Ä–∞–Ω–∏–º—ã–º —Ö–µ—à–µ–º
                // –î–ª—è –ø–∞—Ä–æ–ª—è "admin123" —Ö–µ—à: 240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9
                return hashedPassword === storedHash;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è:', error);
                return false;
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function toggleEditMode(enable) {
            const elements = document.querySelectorAll('[data-content-key]');
            
            elements.forEach(el => {
                el.contentEditable = enable;
            });
            
            document.getElementById('adminPanel').classList.toggle('hidden', !enable);
            document.getElementById('adminLoginBtn').style.display = enable ? 'none' : 'block';
            
            if (enable) {
                showStatus('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            
            if (type === 'success') {
                statusElement.style.color = '#28a745';
            } else if (type === 'error') {
                statusElement.style.color = '#dc3545';
            } else {
                statusElement.style.color = '#666';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Ö–æ–¥–∞
        function showLoginMessage(message) {
            const messageElement = document.getElementById('loginMessage');
            messageElement.textContent = message;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            loadContent();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('adminLoginBtn').addEventListener('click', () => {
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
                showLoginMessage('');
            });
            
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('loginModal').classList.add('hidden');
            });
            
            document.getElementById('publishBtn').addEventListener('click', publishChanges);
            
            document.getElementById('logoutBtn').addEventListener('click', () => {
                isAdmin = false;
                toggleEditMode(false);
                loadContent(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
                showStatus('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
            });
            
            // Enter –¥–ª—è –≤—Ö–æ–¥–∞
            document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            // –ö–ª–∏–∫ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('loginModal').addEventListener('click', (e) => {
                if (e.target.id === 'loginModal') {
                    document.getElementById('loginModal').classList.add('hidden');
                }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞
        async function handleLogin() {
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!password) {
                showLoginMessage('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            loginBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            loginBtn.disabled = true;
            
            try {
                if (await checkPassword(password)) {
                    isAdmin = true;
                    document.getElementById('loginModal').classList.add('hidden');
                    toggleEditMode(true);
                    showLoginMessage('');
                } else {
                    showLoginMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                }
            } catch (error) {
                showLoginMessage('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                loginBtn.textContent = '–í–æ–π—Ç–∏';
                loginBtn.disabled = false;
            }
        }

        // Real-time –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        supabase
            .channel('content-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'site_content' }, 
                (payload) => {
                    console.log('–ü–æ–ª—É—á–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:', payload);
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                    if (!isAdmin) {
                        loadContent();
                    }
                }
            )
            .subscribe();
    </script>
</body>
</html>
